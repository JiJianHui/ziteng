function Hashtable(){this._hash={};this._count=0;this._keys=new Array();this.add=function(a,b){if(this._hash.hasOwnProperty(a)){return false;}else{this._hash[a]=b;this._keys.push(a);this._count++;return true;}};this.remove=function(a){delete this._hash[a];this._keys.remove(a);this._count--;};this.count=function(){return this._count;};this.items=function(a){if(this.contains(a)){return this._hash[a];}};this.values=function(){var d=new Array();for(var a=0;a<this._keys.length;a++){var b=this.items(this._keys[a]);var c={I:this._keys[a],X:b.lng,Y:b.lat};d.push(c);}return d;};this.keys=function(){return this._keys;};this.contains=function(a){return this._hash.hasOwnProperty(a);};this.clear=function(){this._hash={};this._count=0;this._keys=new Array();};}function checkHover(a,b){if(getEvent(a).type=="mouseover"){return !contains(b,getEvent(a).relatedTarget||getEvent(a).fromElement)&&!((getEvent(a).relatedTarget||getEvent(a).fromElement)===b);}else{return !contains(b,getEvent(a).relatedTarget||getEvent(a).toElement)&&!((getEvent(a).relatedTarget||getEvent(a).toElement)===b);}}function contains(b,a){if(b.contains){return b!=a&&b.contains(a);}else{return !!(b.compareDocumentPosition(a)&16);}}function getEvent(a){return a||window.event;}var ListRightMapClient=Elong.Page.ListRightMapClient;ListRightMapClient=Class.create();Object.extend(ListRightMapClient.prototype,{name:"ListRightMapClient",SearchRequestInfo:ListController.AjaxInfo.SearchRequestInfo,hashHotel:new Hashtable(),HotelsMapData:null,PoiMapData:null,SidebarMap:$("#sidebarMap"),MapTop:$("#sidebarMap").offset().top,ZoomOrMoveChange:false,fixMap:false,MoveNum:0,initialize:function(b){Object.extend(Object.extend(this,this.options),b);this.hotelListMapData=new Array();var a=!String.isNullOrEmpty(this.SearchRequestInfo.NationalCityName)?this.SearchRequestInfo.NationalCityName:this.SearchRequestInfo.CityName;if(String.isNullOrEmpty(a)){a="北京";}this.mapSource=new BMap.Map(document.getElementById("rightMap"),{enableMapClick:false});this.mapSource.centerAndZoom(a,10);this.mapSource.disableDoubleClickZoom();this.mapSource.disableScrollWheelZoom();this.mapSource.addControl(new BMap.NavigationControl({anchor:BMAP_ANCHOR_TOP_LEFT,type:BMAP_NAVIGATION_CONTROL_ZOOM}));this.reloadMapData();this.RemarkPoiOnMap();this.RemarkHotelsOnMap(this.getShowMapHotels());this.mouseEvent();$(window).bind("scroll",function(){var c=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop;if(c>=this.MapTop&&c<($("#seohotpoi").offset().top-this.SidebarMap.outerHeight()+220)){this.SidebarMap.attr("class","sidebarMap detailFix");}else{this.SidebarMap.attr("class","sidebarMap");}this.ScorllAndRedrawMap();}.bindAsEventListener(this));FunctionExt.defer(function(){$("div.anchorBL").hide();$("span[_cid='1']").hide();},800);this.mapSource.addEventListener("zoomend",this.ChangeZoomOrBound.bind(this));this.mapSource.addEventListener("moveend",function(){if(this.MoveNum>2){this.mapSource.enableScrollWheelZoom();}this.MoveNum=this.MoveNum+1;}.bind(this));this.mapSource.addEventListener("mouseout",function(){this.mapSource.disableScrollWheelZoom();}.bind(this));},mouseEvent:function(){var a=this;$("#hotelList").children().bind("mouseover",function(c){if(checkHover(c,this)){var b=a.getOverLayerById($(this).attr("id").replace("hotel",""));if(b==null){return;}b.setZIndex(100);$("#label_"+b.id).attr("class","mapIconHotel5");b.setOffset(new BMap.Size(-10,-29));}});$("#hotelList").children().bind("mouseout",function(c){if(checkHover(c,this)){var b=a.getOverLayerById($(this).attr("id").replace("hotel",""));if(b==null){return;}b.setZIndex(10);$("#label_"+b.id).attr("class","mapIconHotel6");b.setOffset(new BMap.Size(-10,-29));}});},getOverLayerById:function(c){var a=this.mapSource.getOverlays();if(a!=null&&a.length>0){for(var b=0;b<a.length;b++){if(a[b].id==c){return a[b];break;}}}return null;},ChangeZoomOrBound:function(){this.ZoomOrMoveChange=true;},RemoveAllOverlays:function(){this.mapSource.clearOverlays();},Reload:function(){this.hashHotel.clear();this.RemoveAllOverlays();this.reloadMapData();this.RemarkPoiOnMap();this.RemarkHotelsOnMap(this.getShowMapHotels());this.mouseEvent();},ScorllAndRedrawMap:function(){this.RemarkHotelsOnMap(this.getShowMapHotels());},RemarkHotelsOnMap:function(c){if(c==null||c.length==0){return;}if(this.hashHotel.count()>0){for(var b=0;b<this.hashHotel.count();b++){$("#label_"+this.hashHotel.keys()[b]).parent().hide();}}for(var a=0;a<c.length;a++){if(Object.isNull(c[a])){continue;}if(!this.hashHotel.contains(c[a].I)){this.hashHotel.add(c[a].I,{lng:c[a].X,lat:c[a].Y});this.addLabel(c[a]);}else{$("#label_"+c[a].I).parent().show();}}},RemarkPoiOnMap:function(){if(this.PoiMapData==null||this.PoiMapData.X==0||this.PoiMapData.Y==0){return;}var d=new BMap.Point(this.PoiMapData.X,this.PoiMapData.Y);var c={position:d,offset:new BMap.Size(-10,-29)};var a="<div id='label_poi_"+this.PoiMapData.I+"' class='mapIconHotel3'><div class='xinxi' title='"+this.PoiMapData.N+"'>"+this.PoiMapData.N+"<span class='s1'></span></div></div>";var b=new BMap.Label(a,c);b.id=this.PoiMapData.I;b.setStyle({background:"none",border:"0"});b.setZIndex(50);this.mapSource.addOverlay(b);this.mapSource.setCenter(d);},addLabel:function(hotelData){var point=new BMap.Point(hotelData.X,hotelData.Y);var opts={position:point,offset:new BMap.Size(-10,-29)};var content="<div id='label_"+hotelData.I+"' class='mapIconHotel6'><div class='xinxi' title='"+hotelData.N+"'>"+hotelData.N+"<span class='s1'></span></div></div>";var that=this;var label=new BMap.Label(content,opts);label.id=hotelData.I;label.setStyle({background:"none",border:"0"});label.addEventListener("mouseover",function(){this.setZIndex(100);$("#label_"+this.id).attr("class","mapIconHotel5");this.setOffset(new BMap.Size(-10,-29));});label.addEventListener("mouseout",function(){this.setZIndex(10);$("#label_"+this.id).attr("class","mapIconHotel6");this.setOffset(new BMap.Size(-10,-29));});label.addEventListener("click",function(){var hotelUrl=new Template(ListController.UrlConfig.Hotel_DetailDynamic).eval({hotelId:this.id,pageType:"hotel"});if(this.id.length>8){hotelUrl=new Template(ListController.UrlConfig.HotelUnsignedDetailUrl).eval({hotelId:this.id});}window.open(hotelUrl);});this.mapSource.addOverlay(label);},convertFromSystem:function(d,c){if(c){var a=0.0065;var b=0.006;if(d){d.lat+=b;d.lng+=a;}}return d;},reloadMapData:function(){var h=function(j){var k=(j.indexOf(".")>0&&j.indexOf("."))||(j.indexOf("-")>0&&j.indexOf("-"))||(j.indexOf("(")>0&&j.indexOf("("))||(j.indexOf("（")>0&&j.indexOf("（"))||j.length;return j.substring(0,k);};var b=new Array();var i=new Array();var a=this.SearchRequestInfo.CityName;$("#hotelList").find("a[method = 'showMap']").each(function(j){var k=$(this).attr("title").replace("地图","");k=h(k);if(k.length>5){k=k.replace(a,"");}if(k.length>5){var l=/大酒店|酒店式公寓|商务酒店|度假酒店|高档公寓|酒店|宾馆|大厦|大饭店|饭店|公寓|客栈|会所|旅店|生活馆/g;k=k.replace(l,"");}k=h(k);b.push({I:$(this).attr("hotelid"),N:k,X:$(this).attr("lng"),Y:$(this).attr("lat"),T:($("#hotel"+$(this).attr("hotelid")).offset().top),H:$("#hotel"+$(this).attr("hotelid")).outerHeight()});i.push({lat:$(this).attr("lat"),lng:$(this).attr("lng")});});this.HotelsMapData=b;var c=this.SearchRequestInfo.StartLat;var d=this.SearchRequestInfo.StartLng;var e=this.SearchRequestInfo.PoiId;var f="";if(((this.SearchRequestInfo.ReturnKeywordsType=="PoiType")&&(!String.isNullOrEmpty(this.SearchRequestInfo.ReturnKeywords)))&&this.SearchRequestInfo.StartLat>0&&this.SearchRequestInfo.StartLng>0){f=this.SearchRequestInfo.ReturnKeywords;}else{if((!String.isNullOrEmpty(this.SearchRequestInfo.PoiName))&&this.SearchRequestInfo.StartLat>0&&this.SearchRequestInfo.StartLng>0){f=this.SearchRequestInfo.PoiName;}}var g=this.convertFromSystem({lat:parseFloat(c),lng:parseFloat(d)},true);this.PoiMapData={I:e,N:f,X:g.lng,Y:g.lat};if(c!=0&&d!=0){i.push({lat:g.lat,lng:g.lng});}if(i.length>0){FunctionExt.defer(function(){this.mapSource.setViewport(i);}.bind(this),500);}},getShowMapHotels:function(){var b=new Array();var c=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0;var d=document.documentElement.clientHeight;if(this.HotelsMapData!=null&&this.HotelsMapData.length>0){for(var a=0;a<this.HotelsMapData.length;a++){if((this.HotelsMapData[a].T>c&&(this.HotelsMapData[a].T+this.HotelsMapData[a].H)<(c+d))||(this.HotelsMapData[a].T<c&&(this.HotelsMapData[a].T+this.HotelsMapData[a].H-20)>c)||((this.HotelsMapData[a].T+this.HotelsMapData[a].H)>(c+d)&&(this.HotelsMapData[a].T+20)<(c+d))){b.push(this.HotelsMapData[a]);}}}return b;}});